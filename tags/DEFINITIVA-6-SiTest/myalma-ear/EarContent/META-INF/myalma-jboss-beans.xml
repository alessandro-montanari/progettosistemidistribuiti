<?xml version="1.0" encoding="UTF-8"?>

<deployment xmlns="urn:jboss:bean-deployer:2.0">

	<application-policy xmlns="urn:jboss:security-beans:1.0"
		name="myalma-security-domain">
		<authentication>

			<login-module code="org.jboss.security.ClientLoginModule"
				flag="required">
				<module-option name="restore-login-identity">true</module-option>
			</login-module>

			<!-- For testing uncomment the module below  			-->
			<login-module code="org.jboss.security.auth.spi.IdentityLoginModule" flag="sufficient">
				<module-option name="principal">silvano.martello@uunibo.it</module-option>
				<module-option name="roles">student,professor,admin</module-option>
			</login-module>

			
			<login-module code="org.jboss.security.auth.spi.DatabaseServerLoginModule" flag="required">
				<module-option name="dsJndiName">java:/myalma-ds</module-option>
				<module-option name="principalsQuery"> SELECT password FROM users WHERE mail=?</module-option>
				<module-option name="rolesQuery">SELECT R.roleName, 'Roles' FROM users_roles UR, roles R WHERE UR.roles_id=R.id and UR.users_mail=?
				</module-option>

				<module-option name="hashAlgorithm">SHA</module-option>
				<module-option name="hashEncoding">rfc2617</module-option>
				<module-option name="hashCharset">UTF-8</module-option>
				<module-option name="hashUserPassword">true</module-option>
				<module-option name="hashStorePassword">false</module-option>
				<module-option name="passwordIsA1Hash">true</module-option>
				<module-option name="storeDigestCallback">org.jboss.security.auth.spi.RFC2617Digest
				</module-option>

				<!-- Not all requests are received in an authenticated format. unauthenticated 
					identity is a login module configuration option that assigns a specific identity 
					(guest, for example) to requests that are made with no associated authentication 
					information. This can be used to allow unprotected servlets to invoke methods 
					on EJBs that do not require a specific role. Such a principal has no associated 
					roles and so can only access either unsecured EJBs or EJB methods that are 
					associated with the unchecked permission constraint. -->
				<module-option name="unauthenticatedIdentity">guest</module-option>

				<!-- <module-option name="managedConnectionFactoryName">jboss.jca:service=TxCM,name=JmsXA</module-option> -->

			</login-module>
		</authentication>
	</application-policy>


</deployment>